<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Central - MultiTiendas Gualeguay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="imag/LOGO-ADMINISTRADOR.png" type="image/x-icon">
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      background: #f4f7fb;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background: linear-gradient(135deg, #007bff, #20f1f5);
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 1.6em;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    main {
      max-width: 1100px;
      margin: 30px auto;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      text-align: left;
      padding: 12px 10px;
      border-bottom: 1px solid #ddd;
      font-size: 15px;
    }
    th {
      background: #007bff;
      color: white;
      font-weight: 600;
    }
    tr:hover {
      background: #eef7ff;
    }
    img {
      height: 60px;
      border-radius: 8px;
      object-fit: contain;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 5px;
      transition: 0.2s;
    }
    button:hover {
      background: #005dc1;
    }
    .danger {
      background: #dc3545;
    }
    .danger:hover {
      background: #b52a36;
    }
    #loader {
      text-align: center;
      font-size: 1.2em;
      color: #555;
    }


  @keyframes aparecer {
    from {
      opacity: 0;
      transform: scale(0.8);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  @keyframes desvanecer {
    from {
      opacity: 1;
      transform: scale(1);
    }
    to {
      opacity: 0;
      transform: scale(0.8);
    }
  }

  .modal-animado {
    animation: aparecer 0.3s ease;
  }

  </style>
</head>
<body>
  <header>‚öôÔ∏è Panel Central de Control - MultiTiendas Gualeguay</header>
  <main>
    <div id="loader">Cargando tiendas...</div>
    <table id="tabla-tiendas" style="display:none;">
      <thead>
        <tr>
          <th>Logo</th>
          <th>Nombre</th>
          <th>WhatsApp</th>
          <th>Direcci√≥n</th>
          <th>Horarios</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    doc,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import QRCode from "https://esm.sh/qrcode@1.5.3";

  const firebaseConfig = {
    apiKey: "AIzaSyA36uwBk0FBDc6rI16BAsqUNe_AXLpv62Q",
    authDomain: "carniceriadonjose-48638.firebaseapp.com",
    projectId: "carniceriadonjose-48638",
    storageBucket: "carniceriadonjose-48638.appspot.com",
    messagingSenderId: "322531750471",
    appId: "1:322531750471:web:78e290c9c81eecc7be3762"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ==============================
  // üß≠ DETECTAR URL BASE SEG√öN ENTORNO
  // ==============================
  function getBaseURL() {
    const { origin, pathname } = window.location;
    if (origin.includes("127.0.0.1") || origin.includes("localhost")) {
      return origin;
    }
    const repo = pathname.split("/")[1];
    return `${origin}/${repo}`;
  }
  const BASE_URL = getBaseURL();

  // ==============================
  // ‚ú® MODAL DE MENSAJE (√âXITO / ERROR / INFO)
  // ==============================
  function mostrarModal(texto, color = "#007bff") {
    const modal = document.createElement("div");
    modal.style.cssText = `
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.6); z-index:9999; backdrop-filter:blur(3px);
    `;
    const card = document.createElement("div");
    card.classList.add("modal-animado");
    card.style.cssText = `
      background:white; padding:25px 40px; border-radius:12px; text-align:center;
      font-family:sans-serif; color:#333; box-shadow:0 4px 12px rgba(0,0,0,0.3);
    `;
    const mensaje = document.createElement("p");
    mensaje.textContent = texto;
    mensaje.style.color = color;
    mensaje.style.fontSize = "16px";
    mensaje.style.marginBottom = "15px";
    const btn = document.createElement("button");
    btn.textContent = "Cerrar";
    btn.style.cssText = `
      background:${color}; color:white; border:none; border-radius:8px;
      padding:8px 16px; cursor:pointer; font-weight:bold;
    `;
    btn.onclick = () => {
      card.style.animation = "desvanecer 0.2s ease";
      setTimeout(() => modal.remove(), 180);
    };
    card.appendChild(mensaje);
    card.appendChild(btn);
    modal.appendChild(card);
    document.body.appendChild(modal);
  }

  // ==============================
  // ‚ö†Ô∏è MODAL DE CONFIRMACI√ìN (CON ANIMACI√ìN)
  // ==============================
  function mostrarConfirmacion(mensaje, callback) {
    const modal = document.createElement("div");
    modal.style.cssText = `
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.6); z-index:9999; backdrop-filter:blur(3px);
    `;
    const card = document.createElement("div");
    card.classList.add("modal-animado");
    card.style.cssText = `
      background:white; padding:25px 40px; border-radius:12px; text-align:center;
      font-family:sans-serif; box-shadow:0 4px 12px rgba(0,0,0,0.3);
    `;
    const texto = document.createElement("p");
    texto.textContent = mensaje;
    texto.style.marginBottom = "15px";
    texto.style.fontSize = "16px";
    texto.style.color = "#333";

    const btns = document.createElement("div");
    btns.style.display = "flex";
    btns.style.justifyContent = "center";
    btns.style.gap = "10px";

    const btnSi = document.createElement("button");
    btnSi.textContent = "Eliminar";
    btnSi.style.cssText = `
      background:#dc3545; color:white; border:none; border-radius:8px;
      padding:8px 16px; cursor:pointer; font-weight:bold;
    `;
    btnSi.onclick = () => {
      modal.remove();
      callback(true);
    };

    const btnNo = document.createElement("button");
    btnNo.textContent = "Cancelar";
    btnNo.style.cssText = `
      background:gray; color:white; border:none; border-radius:8px;
      padding:8px 16px; cursor:pointer; font-weight:bold;
    `;
    btnNo.onclick = () => {
      card.style.animation = "desvanecer 0.2s ease";
      setTimeout(() => modal.remove(), 180);
    };

    btns.appendChild(btnNo);
    btns.appendChild(btnSi);
    card.appendChild(texto);
    card.appendChild(btns);
    modal.appendChild(card);
    document.body.appendChild(modal);
  }

  // ==============================
  // ‚öôÔ∏è CARGAR TODAS LAS TIENDAS
  // ==============================
  async function cargarTiendas() {
    const tabla = document.getElementById("tabla-tiendas");
    const tbody = tabla.querySelector("tbody");
    const loader = document.getElementById("loader");

    try {
      const snapshot = await getDocs(collection(db, "tiendas"));
      tbody.innerHTML = "";

      if (snapshot.empty) {
        loader.textContent = "No hay tiendas registradas a√∫n.";
        return;
      }

      for (const tiendaDoc of snapshot.docs) {
        const tiendaId = tiendaDoc.id;
        const configSnap = await getDocs(collection(db, "tiendas", tiendaId, "config"));
        let datos = {};
        configSnap.forEach((d) => (datos = d.data()));

        const urlTienda = `${BASE_URL}/index.html?tienda=${tiendaId}`;
        const urlAdmin = `${BASE_URL}/admin.html?tienda=${tiendaId}`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><img src="${datos.logo || 'https://via.placeholder.com/80'}" alt="logo"></td>
          <td><strong>${datos.nombre || tiendaId}</strong></td>
          <td>${datos.whatsapp || '-'}</td>
          <td>${datos.direccion || '-'}</td>
          <td>${datos.horarios || '-'}</td>
          <td>
            <button onclick="window.open('${urlTienda}', '_blank')">üõçÔ∏è Ver Tienda</button>
            <button onclick="window.open('${urlAdmin}', '_blank')">üß∞ Admin</button>
            <button onclick="mostrarQR('${tiendaId}', '${urlTienda}', '${(datos.nombre || tiendaId).replace(/'/g, "\\'")}')">üî≥ QR</button>
            <button class="danger" onclick="eliminarTienda('${tiendaId}')">üóëÔ∏è Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      }

      tabla.style.display = "table";
      loader.style.display = "none";
    } catch (error) {
      console.error(error);
      loader.textContent = "‚ùå Error al cargar tiendas.";
    }
  }

 

// ==============================
// üî≥ MOSTRAR QR CON DESCARGA PNG + PDF
// ==============================
window.mostrarQR = async function (tiendaId, url, nombre) {
  const modal = document.createElement("div");
  modal.style.cssText = `
    position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    display:flex; align-items:center; justify-content:center; z-index:9999;
  `;
  const cont = document.createElement("div");
  cont.classList.add("modal-animado");
  cont.style.cssText = `
    background:white; padding:20px; border-radius:12px;
    text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.3);
  `;

  // T√≠tulo
  const titulo = document.createElement("h3");
  titulo.textContent = `QR - ${nombre}`;

  // Generar QR
  const canvas = document.createElement("canvas");
  await QRCode.toCanvas(canvas, url, { width: 250 });

  // Enlace debajo del QR
  const enlace = document.createElement("p");
  enlace.innerHTML = `<a href="${url}" target="_blank">${url}</a>`;

  // üì• Bot√≥n de descarga PNG
  const btnDescargar = document.createElement("button");
  btnDescargar.textContent = "üì• Descargar PNG";
  btnDescargar.style.cssText = `
    background:#007bff; color:white; border:none; border-radius:8px;
    padding:8px 16px; cursor:pointer; font-weight:bold; margin-right:10px;
  `;
  btnDescargar.onclick = () => {
    const enlaceDescarga = document.createElement("a");
    enlaceDescarga.href = canvas.toDataURL("image/png");
    enlaceDescarga.download = `QR_${nombre.replace(/\s+/g, "_")}.png`;
    enlaceDescarga.click();
  };

 // üñ®Ô∏è Bot√≥n de descarga PDF
const btnPDF = document.createElement("button");
btnPDF.textContent = "üñ®Ô∏è Descargar PDF";
btnPDF.style.cssText = `
  background:#28a745; color:white; border:none; border-radius:8px;
  padding:8px 16px; cursor:pointer; font-weight:bold; margin-right:10px;
`;

btnPDF.onclick = async () => {
  // Importar correctamente jsPDF (funciona en todos los navegadores)
  const jsPDFModule = await import("https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js");
  const jsPDF = jsPDFModule.jsPDF || jsPDFModule.default?.jsPDF || window.jspdf?.jsPDF;

  if (!jsPDF) {
    alert("‚ùå No se pudo cargar jsPDF. Verific√° tu conexi√≥n o la versi√≥n del script.");
    return;
  }

  const pdf = new jsPDF();

  // T√≠tulo del PDF
  pdf.setFontSize(20);
  pdf.text(nombre, 105, 25, { align: "center" });

  // Imagen del QR (centrada)
  const imgData = canvas.toDataURL("image/png");
  pdf.addImage(imgData, "PNG", 57, 40, 96, 96);

  // Enlace de la tienda debajo del QR
  pdf.setFontSize(12);
  pdf.textWithLink(url, 105, 150, { url, align: "center" });

  // Descargar PDF
  pdf.save(`QR_${nombre.replace(/\s+/g, "_")}.pdf`);
};



  // Cerrar modal
  const btnCerrar = document.createElement("button");
  btnCerrar.textContent = "Cerrar";
  btnCerrar.style.cssText = `
    background:gray; color:white; border:none; border-radius:8px;
    padding:8px 16px; cursor:pointer; font-weight:bold;
  `;
  btnCerrar.onclick = () => {
    cont.style.animation = "desvanecer 0.2s ease";
    setTimeout(() => modal.remove(), 180);
  };

  // Contenedor de botones
  const btnContainer = document.createElement("div");
  btnContainer.style.marginTop = "10px";
  btnContainer.appendChild(btnDescargar);
  btnContainer.appendChild(btnPDF);
  btnContainer.appendChild(btnCerrar);

  // Estructura del modal
  cont.appendChild(titulo);
  cont.appendChild(canvas);
  cont.appendChild(enlace);
  cont.appendChild(btnContainer);
  modal.appendChild(cont);
  document.body.appendChild(modal);
};


  // ==============================
  // üóëÔ∏è ELIMINAR TIENDA COMPLETA
  // ==============================
  window.eliminarTienda = async function (tiendaId) {
    mostrarConfirmacion(`¬øEliminar permanentemente la tienda "${tiendaId}"?`, async (confirmado) => {
      if (!confirmado) return;
      try {
        const productosSnap = await getDocs(collection(db, "tiendas", tiendaId, "productos"));
        for (const productoDoc of productosSnap.docs) {
          await deleteDoc(doc(db, "tiendas", tiendaId, "productos", productoDoc.id));
        }
        await deleteDoc(doc(db, "tiendas", tiendaId, "config", "datos"));
        await deleteDoc(doc(db, "tiendas", tiendaId));
        mostrarModal(`‚úÖ Tienda "${tiendaId}" eliminada correctamente.`, "#28a745");
        cargarTiendas();
      } catch (error) {
        console.error(error);
        mostrarModal("‚ùå Error al eliminar la tienda. Revis√° la consola.", "#dc3545");
      }
    });
  };

  // ==============================
  // üöÄ INICIALIZAR PANEL
  // ==============================
  cargarTiendas();
</script>

</body>
</html>